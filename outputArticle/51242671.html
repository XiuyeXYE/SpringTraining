<style type="text/css" >div{color:#008B8B;}</style>
<h1 style='color:green;'>        java 线程隐含同步错误 包装类            </h1>
<div id="article_content" class="article_content">
<br/>
<pre code_snippet_id="1661037" snippet_file_name="blog_20160425_1_9950112"  name="code" class="java">package com.test;<br/>
<br/>
import java.util.ArrayList;<br/>
import java.util.List;<br/>
import java.util.concurrent.Callable;<br/>
import java.util.concurrent.CompletionService;<br/>
import java.util.concurrent.ExecutionException;<br/>
import java.util.concurrent.ExecutorCompletionService;<br/>
import java.util.concurrent.ExecutorService;<br/>
import java.util.concurrent.Executors;<br/>
import java.util.concurrent.Future;<br/>
<br/>
public class ManyFileUpload {<br/>
<br/>
	private static Integer num = 0;<br/>
<br/>
	public static int getInt() {<br/>
		synchronized (num) {//这样的线程同步是有问题的 因为每一次num在++后都是新对象了具体参见包装类<br/>
			return ++num;<br/>
		}<br/>
<br/>
	}<br/>
<br/>
	public static void main(String[] args) throws InterruptedException,<br/>
			ExecutionException {<br/>
		ExecutorService pool = Executors.newCachedThreadPool();<br/>
<br/>
		List&lt;Callable&lt;Integer&gt;&gt; list = new ArrayList&lt;Callable&lt;Integer&gt;&gt;();<br/>
<br/>
		int all[] = new int[101];<br/>
		<br/>
		for(int i : all){<br/>
			i = 1;//不起作用<br/>
		}<br/>
		<br/>
		for(int i : all){<br/>
			System.out.println(i);<br/>
		}<br/>
		System.out.println(&quot;========================&quot;);<br/>
		for (int i = 0; i &lt; 100; i++) {<br/>
<br/>
			list.add(new Callable&lt;Integer&gt;() {<br/>
<br/>
				@Override<br/>
				public Integer call() throws Exception {<br/>
<br/>
					return ++num;<br/>
				}<br/>
<br/>
			});<br/>
<br/>
		}<br/>
<br/>
		List&lt;Future&lt;Integer&gt;&gt; futures = pool.invokeAll(list);<br/>
<br/>
		for (Future f : futures) {<br/>
			int i = (Integer) f.get();<br/>
			all[i]++;<br/>
			System.out.println(i);<br/>
		}<br/>
		<br/>
		System.out.println(&quot;========================&quot;);<br/>
		for(int i=0;i&lt;100;i++){<br/>
			System.out.println(i+&quot;:&quot;+all[i]);<br/>
		}<br/>
		<br/>
		<br/>
		pool.shutdown();<br/>
		<br/>
		<br/>
<br/>
	}<br/>
<br/>
}<br/>
</pre><br><br/>
<pre code_snippet_id="1661037" snippet_file_name="blog_20160425_2_5806438"  name="code" class="java">0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
0<br/>
========================<br/>
1<br/>
2<br/>
3<br/>
6<br/>
4<br/>
5<br/>
7<br/>
8<br/>
18<br/>
9<br/>
10<br/>
11<br/>
13<br/>
12<br/>
17<br/>
14<br/>
15<br/>
16<br/>
25<br/>
19<br/>
24<br/>
23<br/>
20<br/>
22<br/>
21<br/>
30<br/>
26<br/>
29<br/>
28<br/>
35<br/>
37<br/>
27<br/>
40<br/>
31<br/>
36<br/>
34<br/>
32<br/>
38<br/>
33<br/>
58<br/>
39<br/>
55<br/>
41<br/>
43<br/>
42<br/>
50<br/>
44<br/>
45<br/>
54<br/>
46<br/>
57<br/>
47<br/>
48<br/>
48<br/>
53<br/>
49<br/>
56<br/>
51<br/>
52<br/>
78<br/>
59<br/>
77<br/>
79<br/>
60<br/>
75<br/>
61<br/>
62<br/>
62<br/>
66<br/>
63<br/>
64<br/>
74<br/>
65<br/>
76<br/>
67<br/>
68<br/>
69<br/>
71<br/>
70<br/>
73<br/>
72<br/>
94<br/>
80<br/>
81<br/>
83<br/>
82<br/>
91<br/>
84<br/>
85<br/>
86<br/>
87<br/>
87<br/>
89<br/>
88<br/>
90<br/>
92<br/>
95<br/>
93<br/>
97<br/>
96<br/>
========================<br/>
0:0<br/>
1:1<br/>
2:1<br/>
3:1<br/>
4:1<br/>
5:1<br/>
6:1<br/>
7:1<br/>
8:1<br/>
9:1<br/>
10:1<br/>
11:1<br/>
12:1<br/>
13:1<br/>
14:1<br/>
15:1<br/>
16:1<br/>
17:1<br/>
18:1<br/>
19:1<br/>
20:1<br/>
21:1<br/>
22:1<br/>
23:1<br/>
24:1<br/>
25:1<br/>
26:1<br/>
27:1<br/>
28:1<br/>
29:1<br/>
30:1<br/>
31:1<br/>
32:1<br/>
33:1<br/>
34:1<br/>
35:1<br/>
36:1<br/>
37:1<br/>
38:1<br/>
39:1<br/>
40:1<br/>
41:1<br/>
42:1<br/>
43:1<br/>
44:1<br/>
45:1<br/>
46:1<br/>
47:1<br/>
48:2<br/>
49:1<br/>
50:1<br/>
51:1<br/>
52:1<br/>
53:1<br/>
54:1<br/>
55:1<br/>
56:1<br/>
57:1<br/>
58:1<br/>
59:1<br/>
60:1<br/>
61:1<br/>
62:2<br/>
63:1<br/>
64:1<br/>
65:1<br/>
66:1<br/>
67:1<br/>
68:1<br/>
69:1<br/>
70:1<br/>
71:1<br/>
72:1<br/>
73:1<br/>
74:1<br/>
75:1<br/>
76:1<br/>
77:1<br/>
78:1<br/>
79:1<br/>
80:1<br/>
81:1<br/>
82:1<br/>
83:1<br/>
84:1<br/>
85:1<br/>
86:1<br/>
87:2<br/>
88:1<br/>
89:1<br/>
90:1<br/>
91:1<br/>
92:1<br/>
93:1<br/>
94:1<br/>
95:1<br/>
96:1<br/>
97:1<br/>
98:0<br/>
99:0<br/>
</pre><br><br/>
   <br/>
</div>
